name: PR Ready for Review

on:
  pull_request:
    types: [ready_for_review]

env:
  STATUS_VALUE: "ğŸ’ŒReview Requested"

jobs:
  update-project-and-notify:
    name: Set PR to Review Requested & Notify
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      # 1. GitHub App Token ìƒì„±
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CARO_BACKEND_APP_ID }}
          private-key: ${{ secrets.CARO_BACKEND_APP_PRIVATE_KEY }}

      # 2. í”„ë¡œì íŠ¸ ìƒíƒœë¥¼ "ğŸ’ŒReview Requested"ë¡œ ì„¤ì •
      - name: Set Status to Review Requested
        uses: github/update-project-action@v3
        with:
          github_token: ${{ steps.generate-token.outputs.token }}
          organization: ${{ github.repository_owner }}
          project_number: ${{ secrets.PROJECT_NUMBER }}
          content_id: ${{ github.event.pull_request.node_id }}
          field: Status
          value: ${{ env.STATUS_VALUE }}

      # 3. PR ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
      - name: Get PR details
        id: pr_details
        uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;

            // Changed files ì¡°íšŒ
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            // ë¦¬ë·°ì–´ ì •ë³´
            const reviewers = pr.requested_reviewers?.map(r => r.login) || [];
            const teamReviewers = pr.requested_teams?.map(t => t.name) || [];
            const allReviewers = [...reviewers, ...teamReviewers.map(t => `team:${t}`)];

            // Labels
            const labels = pr.labels?.map(l => l.name) || [];

            // í†µê³„
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const changedFiles = files.data.length;

            // íŒŒì¼ íƒ€ì…ë³„ ë¶„ë¥˜
            const fileTypeEmojis = {
              'kt': 'ğŸŸ£',
              'java': 'â˜•',
              'yml': 'ğŸ“',
              'yaml': 'ğŸ“',
              'md': 'ğŸ“„',
              'json': 'ğŸ“‹',
              'xml': 'ğŸ“°',
              'gradle': 'ğŸ˜',
              'kts': 'ğŸŸ£',
              'sql': 'ğŸ—„ï¸',
              'sh': 'ğŸš',
              'properties': 'âš™ï¸'
            };

            const fileTypes = {};
            files.data.forEach(file => {
              const ext = file.filename.split('.').pop();
              fileTypes[ext] = (fileTypes[ext] || 0) + 1;
            });

            const fileTypesSummary = Object.entries(fileTypes)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3)
              .map(([ext, count]) => {
                const emoji = fileTypeEmojis[ext] || 'ğŸ“';
                return `${emoji} ${ext}(${count})`;
              })
              .join(', ');

            // Outputs ì„¤ì •
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_title', pr.title);
            core.setOutput('pr_url', pr.html_url);
            core.setOutput('pr_user', pr.user.login);
            core.setOutput('pr_head_ref', pr.head.ref);
            core.setOutput('pr_base_ref', pr.base.ref);
            core.setOutput('reviewers', allReviewers.join(', '));
            core.setOutput('labels', labels.join(', '));
            core.setOutput('additions', additions);
            core.setOutput('deletions', deletions);
            core.setOutput('changed_files', changedFiles);
            core.setOutput('file_types', fileTypesSummary || 'N/A');

      # 4. Slack ì•Œë¦¼ ì „ì†¡
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            channel: ${{ secrets.SLACK_GIT_NOTIFY_CHANNEL_ID }}
            text: "ğŸ‘€ ìƒˆë¡œìš´ PR ë¦¬ë·° ìš”ì²­: ${{ steps.pr_details.outputs.pr_title }}"
            blocks:
              - type: "header"
                text:
                  type: "plain_text"
                  text: "ğŸ‘€ ìƒˆë¡œìš´ PR ë¦¬ë·° ìš”ì²­"
                  emoji: true
              - type: "section"
                fields:
                  - type: "mrkdwn"
                    text: "*ì œëª©*\n<${{ steps.pr_details.outputs.pr_url }}|${{ steps.pr_details.outputs.pr_title }}>"
                  - type: "mrkdwn"
                    text: "*ì‘ì„±ì*\n<https://github.com/${{ steps.pr_details.outputs.pr_user }}|@${{ steps.pr_details.outputs.pr_user }}>"
              - type: "section"
                fields:
                  - type: "mrkdwn"
                    text: "*ë¸Œëœì¹˜*\n`${{ steps.pr_details.outputs.pr_head_ref }}` â†’ `${{ steps.pr_details.outputs.pr_base_ref }}`"
                  - type: "mrkdwn"
                    text: "*Status*\n${{ env.STATUS_VALUE }}"
              - type: "section"
                fields:
                  - type: "mrkdwn"
                    text: "*ë³€ê²½ì‚¬í•­*\n:heavy_plus_sign: ${{ steps.pr_details.outputs.additions }} / :heavy_minus_sign: ${{ steps.pr_details.outputs.deletions }} (${{ steps.pr_details.outputs.changed_files }} files)"
                  - type: "mrkdwn"
                    text: "*íŒŒì¼ íƒ€ì…*\n${{ steps.pr_details.outputs.file_types }}"
              - type: "section"
                fields:
                  - type: "mrkdwn"
                    text: "*ë¦¬ë·°ì–´*\n${{ steps.pr_details.outputs.reviewers || 'ì§€ì •ë˜ì§€ ì•ŠìŒ' }}"
                  - type: "mrkdwn"
                    text: "*Labels*\n${{ steps.pr_details.outputs.labels || 'None' }}"
              - type: "divider"
              - type: "actions"
                elements:
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "PR ë³´ê¸°"
                      emoji: true
                    url: "${{ steps.pr_details.outputs.pr_url }}"
                    style: "primary"
                  - type: "button"
                    text:
                      type: "plain_text"
                      text: "Files Changed"
                      emoji: true
                    url: "${{ steps.pr_details.outputs.pr_url }}/files"
              - type: "context"
                elements:
                  - type: "mrkdwn"
                    text: "ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ™"
