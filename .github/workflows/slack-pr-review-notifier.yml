name: Slack PR Review Notifier

on:
  pull_request:
    types:
      - ready_for_review    # Draft â†’ Ready ì „í™˜
      - review_requested    # ë¦¬ë·°ì–´ ì§€ì •
      - synchronize         # ì½”ë“œ í‘¸ì‹œ (ë¦¬ë·° ì¤‘ ì—…ë°ì´íŠ¸)
  pull_request_review:
    types:
      - submitted           # ë¦¬ë·° ì œì¶œ

jobs:
  check-and-notify:
    runs-on: ubuntu-latest
    # Draft PRì€ ì œì™¸
    if: github.event.pull_request.draft == false

    steps:
      # 1. GitHub App Token ìƒì„±
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.CARO_BACKEND_APP_ID }}
          private-key: ${{ secrets.CARO_BACKEND_APP_PRIVATE_KEY }}

      # 2. Projects APIë¡œ í˜„ì¬ Status ì¡°íšŒ
      - name: Get PR Project Status
        id: project
        uses: actions/github-script@v7
        env:
          PROJECT_NUMBER: ${{ secrets.PROJECT_NUMBER }}
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const projectNumber = parseInt(process.env.PROJECT_NUMBER);
            const prNumber = context.issue.number;

            // PRì˜ Project Item ì¡°íšŒ
            const query = `
              query($owner: String!, $repo: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $prNumber) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          number
                          title
                          url
                        }
                        fieldValues(first: 20) {
                          nodes {
                            ... on ProjectV2ItemFieldSingleSelectValue {
                              name
                              field {
                                ... on ProjectV2SingleSelectField {
                                  id
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            let status = 'not_in_project';
            let priority = 'N/A';
            let projectTitle = '';
            let projectUrl = '';

            try {
              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                prNumber: prNumber
              });

              const projectItems = result.repository.pullRequest.projectItems.nodes;

              // Project #26ì˜ ì•„ì´í…œ ì°¾ê¸°
              const targetProjectItem = projectItems.find(
                item => item.project.number === projectNumber
              );

              if (targetProjectItem) {
                projectTitle = targetProjectItem.project.title;
                projectUrl = targetProjectItem.project.url;

                // Status í•„ë“œ ê°’ ì°¾ê¸°
                const statusField = targetProjectItem.fieldValues.nodes.find(
                  field => field.field?.name === 'Status'
                );
                status = statusField?.name || 'No Status';

                // Priority í•„ë“œ ê°’ ì°¾ê¸°
                const priorityField = targetProjectItem.fieldValues.nodes.find(
                  field => field.field?.name === 'Priority'
                );
                priority = priorityField?.name || 'N/A';

                console.log('âœ… Project found:', projectTitle);
                console.log('ğŸ“Š Status:', status);
                console.log('ğŸ”¥ Priority:', priority);
              } else {
                console.log('âš ï¸ PR is not in project #' + projectNumber);
              }
            } catch (error) {
              console.error('âŒ Error fetching project status:', error.message);
            }

            core.setOutput('status', status);
            core.setOutput('priority', priority);
            core.setOutput('project_title', projectTitle);
            core.setOutput('project_url', projectUrl);

      # 3. ì•Œë¦¼ í•„ìš” ì—¬ë¶€ ì²´í¬
      - name: Check if notification needed
        id: check_notify
        run: |
          STATUS="${{ steps.project.outputs.status }}"
          NOTIFY=false

          echo "ğŸ“‹ Current Status: $STATUS"

          # ë¦¬ë·° ê°€ëŠ¥í•œ ìƒíƒœ: "ğŸ’ŒReview Requested", "ğŸ˜In Review"
          if [[ "$STATUS" == "ğŸ’ŒReview Requested" ]] || \
             [[ "$STATUS" == "ğŸ˜In Review" ]]; then
            NOTIFY=true
            echo "âœ… Notification will be sent"
          else
            echo "â­ï¸ Skipping notification (Status: $STATUS)"
          fi

          echo "notify=$NOTIFY" >> $GITHUB_OUTPUT

      # 4. PR ìƒì„¸ ì •ë³´ ìˆ˜ì§‘
      - name: Get PR details
        if: steps.check_notify.outputs.notify == 'true'
        id: pr_details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Changed files ì¡°íšŒ
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_request_number: pr.number
            });

            // ë¦¬ë·°ì–´ ì •ë³´
            const reviewers = pr.requested_reviewers?.map(r => r.login) || [];
            const teamReviewers = pr.requested_teams?.map(t => t.name) || [];
            const allReviewers = [...reviewers, ...teamReviewers.map(t => `team:${t}`)];

            // Labels
            const labels = pr.labels?.map(l => l.name) || [];

            // í†µê³„
            const additions = pr.additions || 0;
            const deletions = pr.deletions || 0;
            const changedFiles = files.data.length;

            // íŒŒì¼ íƒ€ì…ë³„ ë¶„ë¥˜
            const fileTypes = {};
            files.data.forEach(file => {
              const ext = file.filename.split('.').pop();
              fileTypes[ext] = (fileTypes[ext] || 0) + 1;
            });

            const fileTypesSummary = Object.entries(fileTypes)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 3)
              .map(([ext, count]) => `${ext}(${count})`)
              .join(', ');

            core.setOutput('reviewers', allReviewers.join(', '));
            core.setOutput('labels', labels.join(', '));
            core.setOutput('additions', additions);
            core.setOutput('deletions', deletions);
            core.setOutput('changed_files', changedFiles);
            core.setOutput('file_types', fileTypesSummary || 'N/A');

      # 5. Slack ì•Œë¦¼ ì „ì†¡
      - name: Send Slack notification
        if: steps.check_notify.outputs.notify == 'true'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: ${{ secrets.SLACK_GIT_NOTIFY_CHANNEL_ID }}
          payload: |
            {
              "text": "ğŸ‘€ ìƒˆë¡œìš´ PR ë¦¬ë·° ìš”ì²­: ${{ github.event.pull_request.title }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸ‘€ ìƒˆë¡œìš´ PR ë¦¬ë·° ìš”ì²­",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ì œëª©*\n<${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì„±ì*\n<https://github.com/${{ github.event.pull_request.user.login }}|@${{ github.event.pull_request.user.login }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ë¸Œëœì¹˜*\n`${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status*\n${{ steps.project.outputs.status }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ë³€ê²½ì‚¬í•­*\n:heavy_plus_sign: ${{ steps.pr_details.outputs.additions }} / :heavy_minus_sign: ${{ steps.pr_details.outputs.deletions }} (${{ steps.pr_details.outputs.changed_files }} files)"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*íŒŒì¼ íƒ€ì…*\n${{ steps.pr_details.outputs.file_types }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Priority*\n${{ steps.project.outputs.priority }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ë¦¬ë·°ì–´*\n${{ steps.pr_details.outputs.reviewers || 'ì§€ì •ë˜ì§€ ì•ŠìŒ' }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Labels*\n${{ steps.pr_details.outputs.labels || 'None' }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Project*\n<${{ steps.project.outputs.project_url }}|${{ steps.project.outputs.project_title }}>"
                    }
                  ]
                },
                {
                  "type": "divider"
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "PR ë³´ê¸°",
                        "emoji": true
                      },
                      "url": "${{ github.event.pull_request.html_url }}",
                      "style": "primary"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Files Changed",
                        "emoji": true
                      },
                      "url": "${{ github.event.pull_request.html_url }}/files"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Project",
                        "emoji": true
                      },
                      "url": "${{ steps.project.outputs.project_url }}"
                    }
                  ]
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": "<!here> ë¦¬ë·° ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ™"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
